# ANTLR Grammar Build Process

## Overview

The ANTLR grammar generates TypeScript files that can be used in the VS Code extension. These generated files are **NOT committed** to version control as they can be regenerated from the source grammar files.

## Generated Files (Excluded from Git)

```
antlr-grammar/generated/     ← Generated by ANTLR
server/src/generated/        ← Copied from antlr-grammar/generated/
```

Both directories are in `.gitignore` as they contain build artifacts.

## Generation Process

### 1. Generate Grammar Files

From the `antlr-grammar/` directory:

```bash
cd antlr-grammar
npm install          # Install dependencies (first time only)
npm run generate     # Generate lexer and parser
```

This creates:
- `generated/ClarionLexer.ts`
- `generated/ClarionParser.ts`
- `generated/ClarionParserListener.ts`
- `generated/ClarionParserVisitor.ts`
- Associated `.tokens` and `.interp` files

### 2. Copy to Server (If Integrating)

To use the grammar in the VS Code extension server:

```bash
# From antlr-grammar directory
xcopy /Y /I generated\*.ts ..\server\src\generated\
```

Or create a script in `package.json`:

```json
{
  "scripts": {
    "copy-to-server": "xcopy /Y /I generated\\*.ts ..\\server\\src\\generated\\"
  }
}
```

### 3. Compile TypeScript

```bash
cd antlr-grammar
npm run build        # Compiles TypeScript to JavaScript
```

## Integration with Extension

When the ANTLR grammar is integrated into the extension:

1. **Development Build:**
   ```bash
   cd antlr-grammar
   npm run generate
   npm run copy-to-server
   cd ../server
   npm run compile
   ```

2. **CI/CD Pipeline:**
   Add generation step before compilation:
   ```yaml
   - name: Generate ANTLR Parser
     run: |
       cd antlr-grammar
       npm install
       npm run generate
       npm run copy-to-server
   ```

3. **User Installation:**
   Pre-built extension package (.vsix) will include compiled JavaScript, so end users don't need to generate anything.

## Why Generated Files Are Excluded

1. **Deterministic**: Can be recreated exactly from grammar files
2. **Large**: Generated files are verbose
3. **Standard Practice**: ANTLR projects typically exclude generated code
4. **Source of Truth**: Grammar files (.g4) are the authoritative source
5. **Clean Diffs**: Changes to grammar show meaningful diffs, not generated code

## First-Time Setup

For developers cloning the repository:

```bash
git clone <repository>
cd Clarion-Extension

# Generate ANTLR files
cd antlr-grammar
npm install
npm run generate

# Install extension dependencies
cd ../server
npm install
cd ../client
npm install

# Build extension
cd ..
npm run compile
```

## Testing Generated Files

```bash
cd antlr-grammar
npm run generate
npm run build
node out/tests/unit-tests/test-parse.js tests/test-files/test-simple.clw
```

## File Structure

```
antlr-grammar/
├── lexer/*.g4          ← Source grammar (COMMITTED)
├── parser/*.g4         ← Source grammar (COMMITTED)
├── generated/*.ts      ← Generated files (IGNORED)
└── out/                ← Compiled JavaScript (IGNORED)

server/src/
└── generated/*.ts      ← Copied from antlr-grammar (IGNORED)
```

## Notes

- Always regenerate after modifying `.g4` files
- The `fix-generated` script patches generated code for compatibility
- Generated files work with antlr4ng runtime
- TypeScript compilation requires `--skipLibCheck` due to antlr4ng types

## See Also

- `antlr-grammar/README.md` - Grammar documentation
- `antlr-grammar/SETUP.md` - Detailed setup guide
